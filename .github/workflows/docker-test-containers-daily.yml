name: Copy test container docker images (daily)

on:
  schedule:
    - cron: "23 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

env:
  # renovate: datasource=github-releases depName=opentelemetry-collector packageName=open-telemetry/opentelemetry-collector-releases
  OTEL_COLLECTOR_VERSION: v0.132.2

jobs:
  set-collector-version:
    runs-on: ubuntu-latest
    outputs:
      otel_collector_version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Set OpenTelemetry Collector version
        id: set-version
        # strip the "v" from the version
        run: echo "version=${OTEL_COLLECTOR_VERSION#v}" >> $GITHUB_OUTPUT

  copy-images:
    needs: set-collector-version
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - source: jaegertracing/all-in-one:1.32
            target_image: jaeger:1.32
          - source: otel/opentelemetry-collector-contrib:${{ needs.set-collector-version.outputs.otel_collector_version }}
            target_image: otel-collector:${{ needs.set-collector-version.outputs.otel_collector_version }}
          - source: shopify/toxiproxy:latest
            target_image: toxiproxy
          - source: eclipse-temurin:17-jre-focal
            target_image: openjdk17
    runs-on: ubuntu-latest
    steps:
      - name: Docker login
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy image
        # Non-debug image doesn't seem to support reading the .docker creds.
        run: |
          docker run --rm -v $HOME/.docker:/root/.docker gcr.io/go-containerregistry/crane:debug \
          cp ${{ matrix.source }} ghcr.io/open-telemetry/opentelemetry-java/${{ matrix.target_image }}
